<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <link rel="stylesheet" href="static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    body {
        background-color: #000000;
        font-family: Arial, sans-serif;
    }
        .main-container {
        display: flex;
        height: 100vh;
    }
    .sidebar {
        width: 250px;
        background-color: #000000;
        padding: 15px;
        overflow-y: auto;
    }
    .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        border: #121212;
        background-color: #121212;
    }
    .session-item {
        padding: 8px 12px;
        margin-bottom: 5px;
        border-radius: 4px;
        cursor: pointer;
        word-break: break-all;
        color: #dee2e6;
        background-color: #380356   ;
    }
    .session-item:hover {
        background-color: #6b0078;
    }
    .session-item.active {
        background-color: #b000b2;
        color: #dee2e6;
    }
    #new-session-btn {
        margin-bottom: 15px;
        width: 100%;
        background-color: #b000b2;
        color: #dee2e6;
    }
    .chat-box {
        flex: 1;
        overflow-y: auto;
        margin-bottom: 15px;
        border: 1px solid #121212;
        border-radius: 5px;
        padding: 15px;
        background-color: #121212;
    }
    #user-input{
        background-color: transparent;
        color: #dee2e6;
    }
    #user-input::placeholder {
    color: #adb5bd;
    opacity: 1;
}
    #send-btn {
        color: #b000b2;
    }
    #send-btn:hover {
        background-color: #b000b2;
        color: #fff;
    }

    </style>
</head>
<body>
    <div class="main-container">
        <div class="sidebar">
            <button id="new-session-btn" class="btn mb-3">New Session</button>
            <div id="sessions-list">
                <!-- Sessions will be loaded here -->
            </div>
        </div>
        
        <div class="chat-container">
            <h4 class="text-center mb-4" style="color: #dee2e6;">Studying Assistant</h4>
            <div id="chat-box" class="chat-box"></div>
            <form id="chat-form" class="d-flex">
                <input type="text" id="user-input" class="form-control me-2" placeholder="Type your message..." required>
                <button type="submit" class="btn" id="send-btn">Send</button>
            </form>
        </div>
    </div>

    <script>
        const form = document.getElementById("chat-form");
        const input = document.getElementById("user-input");
        const chatBox = document.getElementById("chat-box");
        const sessionsList = document.getElementById("sessions-list");
        const newSessionBtn = document.getElementById("new-session-btn");
        
        let currentSessionId = null;

        // Load sessions when page loads
        document.addEventListener("DOMContentLoaded", loadSessions);

        async function loadSessions() {
            try {
        const response = await fetch("/sessions");
        const sessions = await response.json();
        
        sessionsList.innerHTML = '';
        sessions.forEach(session => {
            const sessionElement = document.createElement("div");
            sessionElement.className = "d-flex justify-content-between align-items-center session-item";
            sessionElement.dataset.sessionId = session.session_id;
            
            // Highlight if this is the current session
            if (session.session_id === currentSessionId) {
                sessionElement.classList.add('active');
            }
            
            const sessionText = document.createElement("span");
            sessionText.className = "session-text";
            sessionText.textContent = session.session_id;
            sessionText.addEventListener("click", () => {
                loadSession(session.session_id);
            });
                
                const dropdownContainer = document.createElement("div");
                dropdownContainer.className = "dropdown";
                
                const menuBtn = document.createElement("button");
                menuBtn.className = "btn btn-sm";
                menuBtn.innerHTML = "...";
                menuBtn.setAttribute("data-bs-toggle", "dropdown");
                menuBtn.setAttribute("aria-expanded", "false");
                menuBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                });
                
                const dropdownMenu = document.createElement("ul");
                dropdownMenu.className = "dropdown-menu dropdown-menu-end";
                
                const deleteOption = document.createElement("li");
                const deleteLink = document.createElement("a");
                deleteLink.className = "dropdown-item text-danger";
                deleteLink.href = "#";
                deleteLink.innerHTML = "Delete Session";
                deleteLink.addEventListener("click", async (e) => {
                    e.preventDefault();
                    if (confirm("Are you sure you want to delete this session?")) {
                        await deleteSession(session.session_id);
                    }
                });
                
                deleteOption.appendChild(deleteLink);
                dropdownMenu.appendChild(deleteOption);
                dropdownContainer.appendChild(menuBtn);
                dropdownContainer.appendChild(dropdownMenu);
                
                sessionElement.appendChild(sessionText);
                sessionElement.appendChild(dropdownContainer);
                sessionsList.appendChild(sessionElement);
            });
            
            if (sessions.length > 0) {
            // If no specific session to select and no current session, pick the most recent
            if (!sessionIdToSelect && !currentSessionId) {
                sessionIdToSelect = sessions[0].session_id; // Most recent is first
            }
            
            const sessionToLoad = sessionIdToSelect || currentSessionId || sessions[0].session_id;
            await loadSession(sessionToLoad);
        }
    } catch (error) {
        console.error("Error loading sessions:", error);
    }
}

        async function deleteSession(sessionId) {
            try {
                const response = await fetch(`/sessions/${sessionId}`, {
                    method: "DELETE"
                });
                
                const result = await response.json();
                if (result.status === "success") {
                    // Reload sessions list
                    await loadSessions();
                    
                    // If we deleted the current session, clear the chat
                    if (sessionId === currentSessionId) {
                        currentSessionId = null;
                        chatBox.innerHTML = '';
                    }
                } else {
                    alert("Failed to delete session: " + result.message);
                }
            } catch (error) {
                console.error("Error deleting session:", error);
                alert("Error deleting session");
            }
        }

        async function loadSession(sessionId) {
        try {
            // Clear current active state from all sessions
            document.querySelectorAll('.session-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set new active session
            currentSessionId = sessionId;
            const activeSessionElement = document.querySelector(`.session-item[data-session-id="${sessionId}"]`);
            if (activeSessionElement) {
                activeSessionElement.classList.add('active');
            }
            
            // Load and display messages
            chatBox.innerHTML = '';
            const response = await fetch(`/sessions/${sessionId}/messages`);
            const messages = await response.json();
            
            messages.forEach(message => {
                appendMessage("user", message.user_message);
                appendMessage("bot", message.agent_message);
            });
            
            // Update URL to reflect current session
            window.history.pushState({}, '', `/?session=${sessionId}`);
            
        } catch (error) {
            console.error("Error loading session:", error);
        }
}

newSessionBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                const response = await fetch("/sessions/new", {
                    method: "POST"
                });
                const data = await response.json();
                await loadSessions(); // Refresh the session list
                await loadSession(data.session_id); // Load and redirect to the new session
                
                // Clear the chat box and focus the input
                chatBox.innerHTML = '';
                input.focus();
            } catch (error) {
                console.error("Error creating new session:", error);
            }
        });

        function appendMessage(sender, text) {
            const messageDiv = document.createElement("div");
            messageDiv.classList.add("message", sender);

            const textSpan = document.createElement("span");
            textSpan.classList.add("text");
            textSpan.textContent = text;

            messageDiv.appendChild(textSpan);
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const userInput = input.value.trim();
            if (!userInput) return;

            appendMessage("user", userInput);
            input.value = "";

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ 
                        input: userInput,
                        session_id: currentSessionId 
                    })
                });

                const data = await res.json();
                appendMessage("bot", data.response);
                
                if (!currentSessionId) {
                    currentSessionId = data.session_id;
                    await loadSessions();
                }
            } catch (error) {
                appendMessage("bot", "Error: " + error.message);
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
</body>
</html>